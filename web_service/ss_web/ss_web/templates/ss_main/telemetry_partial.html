{% load static %}
<style>
.telemetry-container .form-control-plaintext {
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 4px;
  padding: .375rem .75rem;
}
.telemetry-container .nav-area {
  background: #f8f9fa;
  padding: .5rem 1rem;
}
.telemetry-container .status-card {
  width: 100px;
  background: #e9ecef;
  border-radius: 4px;
  text-align: center;
  padding: .5rem;
  margin: .25rem;
}

.telemetry-container .power-card {
  width: 100%;
  max-width: none;
  background: #e9ecef;
  border: 1px solid #ced4da;
  border-radius: 4px;
  text-align: center;
  padding: .75rem;
  margin-bottom: 1rem;
}
.telemetry-container .power-card .display-4 {
  font-size: 2rem;
}

.telemetry-container .grid-table-wrapper {
  margin-left: 0;
}
.telemetry-container .sticker-area {
  background: #e9ecef;
  padding: .5rem;
  border-radius: 4px;
  display: flex;
  align-items: center;
  gap: .5rem;
}
  .telemetry-container .power-card {
  margin-bottom: 0.25rem !important;
}


.telemetry-container .grid-table-wrapper {
  margin-top: 0 !important;
}

  .telemetry-grid-new {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-family: Arial, sans-serif;
    background-color: #ffffff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }

  .telemetry-grid-new thead {
    background-color: #007bff;
    color: #ffffff;
  }

  .telemetry-grid-new th,
  .telemetry-grid-new td {
    padding: 0.6rem 0.8rem;
    border: 1px solid #dee2e6;
    text-align: center;
    vertical-align: middle;
  }

  .telemetry-grid-new tbody tr:nth-child(odd) {
    background-color: #f8f9fa;
  }

  .telemetry-grid-new tbody tr:hover {
    background-color: #e2e6ea;
  }


  .telemetry-container {
    position: relative;
    transition: opacity 0.4s ease;
  }
  .telemetry-container.refreshing {
    opacity: 0.4;
  }
</style>

<div class="container-fluid telemetry-container">

  <div class="row mb-3">
    <div class="col-md-2 mb-2">
      <label class="small font-weight-bold">QR</label>
      <input type="text" readonly class="form-control form-control-sm form-control-plaintext" value="{{ qr_code }}">
    </div>
    <div class="col-md-2 mb-2">
      <label class="small font-weight-bold">Box ‚Ññ</label>
      <input type="text" id="cabinet-number" readonly class="form-control form-control-sm form-control-plaintext font-weight-bold" value="{{ box_number }}">
    </div>
    <div class="col-md-3 mb-2">
      <label class="small font-weight-bold">IMEI</label>
      <input type="text" readonly class="form-control form-control-sm form-control-plaintext" value="{{ imei }}">
    </div>
    <div class="col-md-3 mb-2">
  <label class="small font-weight-bold">
    <a href="#" id="loadIccid" class="text-primary">ICCID</a>
  </label>
  <input
    type="text"
    id="iccidField"
    readonly
    class="form-control form-control-sm form-control-plaintext"
    value=""
  >
</div>
  </div>


<div class="row nav-area mb-3 align-items-center">
  <div class="col-auto">
    <button class="btn btn-primary btn-sm ml-2" onclick="refreshTelemetry()">‚Üª Refresh</button>
    <button class="btn btn-primary btn-sm ml-2" disabled>Send Command</button>
  </div>
  <div class="col text-center">
    <a
      href="https://www.google.com/maps/search/?api=1&query={{ coordinates|urlencode }}"
      target="_blank"
      class="font-weight-bold text-primary"
    >
      –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: {{ coordinates }}
    </a>
    <small class="text-muted ml-2">{{ gps_info }}</small>
  </div>
  <button
    class="btn btn-secondary settings-button"
    onclick="loadCabinetSettings({{ box_number }})"
  >
    Settings
  </button>
</div>

  <div class="d-flex flex-wrap mb-3">
    <div class="status-card">
      <div class="font-weight-bold small">Reserv Voltage</div>
      <div>{{ reserv_voltage }}</div>
    </div>
    <div class="status-card">
      <div class="font-weight-bold small">IN1, door</div>
      <div>{{ in1 }}</div>
    </div>
    <div class="status-card">
      <div class="font-weight-bold small">IN2, cool</div>
      <div>{{ in2 }}</div>
    </div>
    <div class="status-card">
      <div class="font-weight-bold small">IN3, smoke</div>
      <div>{{ in3 }}</div>
    </div>
    <div class="status-card">
      <div class="font-weight-bold small">OUT1, locker</div>
      <div>{{ out1 }}</div>
    </div>
    <div class="status-card">
      <div class="font-weight-bold small">OUT2, offPWR</div>
      <div>{{ out2 }}</div>
    </div>
    <div class="status-card">
      <div class="font-weight-bold small">1-w T1</div>
      <div>{{ t1 }}</div>
    </div>
    <div class="status-card">
      <div class="font-weight-bold small">1-w T2</div>
      <div>{{ t2 }}</div>
    </div>
    <div class="status-card">
      <div class="font-weight-bold small">1-w T3</div>
      <div>{{ t3 }}</div>
    </div>
    <div class="status-card">
      <div class="font-weight-bold small">1-w T4</div>
      <div>{{ t4 }}</div>
    </div>
  </div>


  <div class="mb-3">
    <div class="power-card">
      <div class="font-weight-bold small text-uppercase">POWER COUNT</div>
      <div class="display-4 mb-0">{{ power_count }}</div>
      <small class="text-muted">kW¬∑h</small>
    </div>
  </div>


  <div class="grid-table-wrapper mb-1">
  <table class="telemetry-grid-new">
    <thead>
      <tr>
        <th>Grid</th>
        <th>Voltage, V</th>
        <th>Current, A</th>
        <th>Cosinus œÜ</th>
        <th>Predicted consumption, W</th>
      </tr>
    </thead>
    <tbody>
      {% for line in lines %}
      <tr>
        <td>{{ line.name }}</td>
        <td>{{ line.V }}</td>
        <td>{{ line.A }}</td>
        <td>{{ line.cos }}</td>
        <td>{{ line.P }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


  <div class="row mb-1">
    <div class="col">
      <div class="sticker-area">
        <span class="font-weight-bold">sticker</span>
        <input type="text" class="form-control form-control-sm" value="{{ sticker }}">
        <button class="btn btn-secondary btn-sm">confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="cabinetSettingsModal" tabindex="-1" role="dialog" aria-labelledby="cabinetSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cabinetSettingsModalLabel">Operation Settings</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="cabinet-settings-content">
                    <p>Loading settings...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveCabinetSettings()">Save changes</button>
            </div>
        </div>
    </div>
</div>
<script>
  function refreshTelemetry() {
    const container = document.querySelector('.telemetry-container');

    // –≤–∫–ª—é—á–∞–µ–º ¬´—Ä–µ–∂–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è¬ª
    container.classList.add('refreshing');

    // –±–µ—Ä—ë–º URL –∏–∑ Django-—Ç–µ–≥–∞
    const url = "{% url 'new_eng_telemetry' box_number %}";

    fetch(url, { credentials: 'same-origin' })
      .then(res => {
        if (!res.ok) throw new Error(res.statusText);
        return res.text();
      })
      .then(html => {
        // –ø–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç, –¥–æ—Å—Ç–∞—ë–º –Ω–æ–≤—É—é –æ–±—ë—Ä—Ç–∫—É
        const doc       = new DOMParser().parseFromString(html, 'text/html');
        const newInner  = doc.querySelector('.telemetry-container').innerHTML;

        // –ø–æ–¥–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —á—Ç–æ–±—ã CSS –æ—Å—Ç–∞–ª—Å—è)
        container.innerHTML = newInner;
        initIccidLoader();

        // –≤—ã–∫–ª—é—á–∞–µ–º ¬´—Ä–µ–∂–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è¬ª —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à–æ–π —Ç–∞–π–º–∞—É—Ç,
        // —á—Ç–æ–±—ã —É—Å–ø–µ–ª –æ—Ç—Ä–∞–±–æ—Ç–∞—Ç—å transition
        setTimeout(() => {
          container.classList.remove('refreshing');
        }, 50);
      })
      .catch(err => {
        console.error(err);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—é: " + err.message);
        container.classList.remove('refreshing');
      });
  }



  function loadCabinetSettings(cabinetId) {
    $('#cabinetSettingsModal').modal('show');

    // AJAX –Ω–∞ –Ω—É–∂–Ω—ã–π URL —Å cabinetId
    $.ajax({
        url: `/cabinet_settings2/${cabinetId}/`,
        method: 'GET',
        success(data) {
            $('#cabinet-settings-content').html(data);
        },
        error() {
            $('#cabinet-settings-content').html('<p>Error loading settings</p>');
        }
    });
}

function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function saveCabinetSettings() {
    var formDataArray = $('#cabinet-settings-form').serializeArray();
    var formData = {};

    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏
    formDataArray.forEach(function (item) {
        if (item.name === 'max_cycle_times' || item.name === 'year_of_manufacture') {
            formData[item.name] = item.value;  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
        } else if (item.name === 'sn_error' || item.name === 'allow_vendor' || item.name === 'allow_sw_ver') {
            // –£—á–∏—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–æ–≤: –µ—Å–ª–∏ –µ—Å—Ç—å –≤ –º–∞—Å—Å–∏–≤–µ, –∑–Ω–∞—á–∏—Ç true
            formData[item.name] = true;
        } else {
            formData[item.name] = item.value;
        }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –Ω–µ–æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤ (–æ–Ω–∏ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    $('input[type="checkbox"]:not(:checked)').each(function () {
        formData[this.name] = false;  // –ï—Å–ª–∏ —á–µ–∫–±–æ–∫—Å –Ω–µ –≤—ã–±—Ä–∞–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ false
    });

    var csrfToken = getCSRFToken();

    $.ajax({
        url: $('#cabinet-settings-form').attr('action'),
        method: 'POST',
        data: formData,
        headers: {
            'X-CSRFToken': csrfToken  // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        },
        success: function(response) {
            console.log(response);  // –õ–æ–≥ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            if (response.success) {
                alert('Settings saved successfully!');
                $('#cabinetSettingsModal').modal('hide');
            } else {
                console.log(response.errors);  // –õ–æ–≥ –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                alert('Error saving settings: ' + JSON.stringify(response.errors));
            }
        },
        error: function(xhr, status, error) {
            console.log(xhr.responseText);  // –õ–æ–≥ –æ—à–∏–±–æ–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            alert('Error saving settings');
        }
    });
}
</script>
<script>
  // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è getCSRFToken() —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –≤–∞—à–µ–º —à–∞–±–ª–æ–Ω–µ
  document.querySelector('.sticker-area button').addEventListener('click', function() {
    const input = document.querySelector('.sticker-area input');
    const stickerValue = input.value;
    fetch("{% url 'update_sticker' box_number %}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': getCSRFToken(),
      },
      body: new URLSearchParams({ sticker: stickerValue })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–µ, –ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ —Ç.–¥.
        alert('Sticker –æ–±–Ω–æ–≤–ª—ë–Ω: ' + data.sticker);
      } else {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.');
      }
    })
    .catch(err => {
      console.error(err);
      alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏.');
    });
  });


 function initIccidLoader() {
  const loadBtn = document.getElementById('loadIccid');
  const iccidField = document.getElementById('iccidField');

  if (!loadBtn || !iccidField) {
    console.warn("‚ö†Ô∏è ICCID —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
    return;
  }

  // –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–µ—Å–ª–∏ –≤—ã–∑—ã–≤–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ)
  loadBtn.replaceWith(loadBtn.cloneNode(true));
  const newBtn = document.getElementById('loadIccid');

  newBtn.addEventListener('click', function (e) {
    e.preventDefault();
    const imei = document.querySelector('input[readonly][value^="8620"]').value;
    const url = `http://79.143.21.106:9000/command/${imei}/iccid`;

    console.log("‚è≥ Fetch ICCID from", url);
    iccidField.value = '–ó–∞–≥—Ä—É–∑–∫–∞...';

    fetch(url)
      .then(r => r.text())
      .then(data => {
        console.log("‚úÖ ICCID –ø–æ–ª—É—á–µ–Ω:", data);
        iccidField.value = data.trim();
      })
      .catch(err => {
        console.error("‚ùå –û—à–∏–±–∫–∞ ICCID:", err);
        iccidField.value = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
      });
  });
}

</script>


<script>
  $('#cabinetTelemetryModal').on('shown.bs.modal', function () {
    console.log("üì¶ –ú–æ–¥–∞–ª–∫–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –ø–æ–∫–∞–∑–∞–Ω–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º ICCID");
    initIccidLoader();
  });
</script>

