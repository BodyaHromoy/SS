<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –®–∫–∞—Ñ–∞ ‚Ññ{{ cabinet.shkaf_id }}</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
    }

    /* ======= –ù–û–í–´–ô –•–≠–î–ï–† ======= */
.header {
  background: #0056B3;
  color: #fff;
  padding: 0.5em 1em;
  position: sticky;
  top: 0;
  z-index: 1000;
  display: flex;
  justify-content: space-between;
  align-items: stretch;
  gap: 1em;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* –õ–µ–≤–∞—è —á–∞—Å—Ç—å —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π */
.header-left {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  gap: 0.3em;
  padding-top: 0.2em;
}

.header-title {
  font-weight: bold;
  font-size: 1rem;
  white-space: nowrap;
  margin-bottom: 0.1em;
  position: relative;
  top: -2px; /* –ø–æ–¥–Ω–∏–º–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ —á—É—Ç—å –≤—ã—à–µ */
}

.header-info {
  display: flex;
  align-items: center;
  gap: 1.5em;
  font-size: 0.85rem;
  white-space: nowrap;
  position: relative;
  top: 2px; /* –Ω–µ–º–Ω–æ–≥–æ –æ–ø—É—Å–∫–∞–µ—Ç –Ω–∏–∂–Ω—é—é —Å—Ç—Ä–æ–∫—É */
}


/* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å —Å –∫–Ω–æ–ø–∫–∞–º–∏, –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
/* –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å ‚Äî –∫–Ω–æ–ø–∫–∏ —Ç–µ–ø–µ—Ä—å –≤ —Ä—è–¥ */
.header-right {
  display: flex;
  align-items: center;
  gap: 0.5em;
  align-self: center; /* –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ –º–µ–∂–¥—É –¥–≤—É–º—è —Å—Ç—Ä–æ–∫–∞–º–∏ */
}

.header-btn {
  background: rgba(255, 255, 255, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: #fff;
  font-size: 1.1em;
  width: 36px;
  height: 36px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.15s ease;
}

.header-btn:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: scale(1.05);
}

/* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (—É–ª—É—á—à–µ–Ω–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ) --- */
.x-modal-content {
  background: #fff;
  padding: 1.8em 2em;
  border-radius: 10px;
  max-width: 520px;
  width: 95%;
  box-shadow: 0 4px 10px rgba(0,0,0,0.25);
  position: relative;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å–µ–∫—Ü–∏–∏ */
.x-modal-content h5 {
  font-weight: 600;
  margin-bottom: 1em;
  text-align: center;
}

.x-modal-content p {
  margin-bottom: 0.6em;
  line-height: 1.4em;
}

/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */
.x-close {
  position: absolute;
  top: 10px;
  right: 10px;
  background: #0056B3;
  color: #fff;
  border: none;
  padding: 0.4em 0.9em;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
}

/* –ë–ª–æ–∫ –≤—ã–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞ */
.x-modal-content form {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}

.x-modal-content form input[type="date"] {
  width: 100%;
  max-width: 220px;
  text-align: center;
}

/* –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç ‚Äî —Ä–∞—Å—Ç—è–Ω—É—Ç–∞ */
.x-modal-content form button {
  width: 100%;
  max-width: 100%;
  font-weight: 600;
  font-size: 1rem;
  padding: 0.8em;
  border-radius: 8px;
}


    /* ======= –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ ======= */
    .main-content {
      max-width: 900px;
      margin: 0 auto;
      padding: 1em;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      padding: 1.5em;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 1.5em;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 0.75em;
      text-align: left;
    }
    table th {
      background: #f2f2f2;
      font-size: 0.9em;
    }

    .scrollable-table {
      max-height: calc(100vh - 350px);
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid #ddd;
    }

    .scrollable-table table thead th {
      position: sticky;
      top: 0;
      background: #f2f2f2;
      z-index: 2;
    }

    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #fff;
      box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
      padding: 0.5em 1em;
      display: flex;
      justify-content: center;
      gap: 1em;
      z-index: 1000;
    }

    .loader {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 12px solid #f3f3f3;
      border-top: 12px solid #3498db;
      border-radius: 50%;
      width: 90px;
      height: 90px;
      animation: spin 1s linear infinite;
      z-index: 2000;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* === –ü–∞–Ω–µ–ª—å –∏ –∫–Ω–æ–ø–∫–∞ === */
    .control-panel {
      text-align: center;
      padding: 1.5em;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 1.5em;
    }

    .open-btn {
      display: block;
      margin: 0 auto;
      font-size: 1.2rem;
      font-weight: 500;
      padding: 0.9em 1em;
      border-radius: 8px;
      white-space: nowrap;
      width: 100%;
      max-width: 480px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }

    #map {
      height: 400px;
      border-radius: 6px;
    }

    .x-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .x-modal.active { display: flex; }

    .x-modal-content {
      background: #fff;
      padding: 1.5em;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      position: relative;
    }

    .x-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #0056B3;
      color: #fff;
      border: none;
      padding: 0.4em 0.9em;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div class="loader" id="loader"></div>

<div class="header">
  <div class="header-left">
    <div class="header-title">{{ cabinet.readable_name|default:"-" }}</div>
    <div class="header-info">
      <span>ID: {{ cabinet.qr|default:"-" }}</span>
      <span>Door: {{ door_state|default:"Unknown" }}</span>
      <span>RPi: {{ cabinet.shkaf_id }}</span>
    </div>
  </div>

  <div class="header-right">
    <button id="map-btn" class="header-btn" title="–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ">üó∫Ô∏è</button>
    <button id="menu-btn" class="header-btn" title="–ò–Ω—Ñ–æ">‚ò∞</button>
  </div>
</div>



<!-- ======= –ú–û–î–ê–õ–ö–ò ======= -->
<div class="x-modal" id="info-modal">
  <div class="x-modal-content">
    <button class="x-close" data-close="#info-modal">X</button>
    <h5 class="mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —à–∫–∞—Ñ–µ</h5>
    <p><strong>–ó–æ–Ω–∞:</strong> {{ cabinet.zone.zone_name|default:"-" }}</p>
    <p><strong>–õ–æ–∫–∞—Ü–∏—è:</strong> {{ cabinet.street|default:"-" }}</p>
    <p><strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:</strong> {{ cabinet.extra_inf|default:"-" }}</p>
    <p><strong>ID –ó–∞–º–∫–∞:</strong> <span id="lock-id">{{ cabinet.qr|default:"-" }}</span>
      <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('lock-id')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </p>

    <hr>

    <h6 class="mt-3 mb-2">–í—ã–≥—Ä—É–∑–∫–∞ –æ—Ç—á–µ—Ç–∞</h6>
    <form method="get" action="{% url 'export_battery_history' cabinet.shkaf_id %}"
          class="d-flex justify-content-between align-items-center flex-wrap"
          style="gap:10px;">
      <input type="date" id="start_date" name="start_date" class="form-control" style="width:150px;">
      <input type="date" id="end_date" name="end_date" class="form-control" style="width:150px;">
      <button type="submit" class="btn btn-success" style="white-space:nowrap;">
        <span class="btn-icon">‚Üì</span>
        <span class="btn-text">–°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç</span>
      </button>
    </form>
  </div>
</div>

<div class="x-modal" id="map-modal">
  <div class="x-modal-content">
    <button class="x-close" data-close="#map-modal">X</button>
    <h5>–õ–æ–∫–∞—Ü–∏—è –®–∫–∞—Ñ–∞ ‚Ññ{{ cabinet.shkaf_id }}</h5>
    <button class="btn btn-primary mb-2" id="gmaps-btn">–û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps</button>
    <div id="map"></div>
  </div>
</div>

<!-- ======= –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ ======= -->
<div class="main-content">
  <div id="chartView" class="card">
    <canvas id="statusBarChart"></canvas>
  </div>

  <div class="card control-panel">
    <button type="button" class="btn btn-warning open-btn" onclick="openCabinet()">
      üö™ –û—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å
    </button>
  </div>

  <div id="tableView" class="card">
    <div class="scrollable-table">
      <table id="statusTable">
        <thead>
          <tr>
            <th>–°–ª–æ—Ç</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ó–∞—Ä—è–¥</th>
            <th>–ú–æ–¥–µ–ª—å</th>
            <th>t¬∞</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="footer">
  <button class="btn btn-secondary" onclick="goBack()">–ù–∞–∑–∞–¥</button>
  <button class="btn btn-primary" onclick="updateData()">–û–±–Ω–æ–≤–∏—Ç—å</button>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const LAT = {{ latitude|default:"null" }};
  const LNG = {{ longitude|default:"null" }};
  let leafletMap = null;

  function goBack(){ window.history.back(); }
  function showLoader(){ document.getElementById('loader').style.display='block'; }
  function hideLoader(){ document.getElementById('loader').style.display='none'; }

  function copyToClipboard(id){
    const el = document.getElementById(id);
    if (!el) return;
    navigator.clipboard.writeText(el.textContent || el.innerText || '');
  }

  const barChart = new Chart(document.getElementById('statusBarChart').getContext('2d'), {
    type:'bar',
    data:{
      labels:['BAN','Inactive','ready','empty','charging','not_charging'],
      datasets:[{
        data:[],
        backgroundColor: ctx=>{
          const colors={ BAN:'#610606', Inactive:'black', ready:'green', empty:'gray', charging:'blue', not_charging:'orange' };
          return colors[ctx.chart.data.labels[ctx.dataIndex]] || 'blue';
        }
      }]
    },
    options:{ responsive:true, plugins:{ legend:{ display:false } } }
  });

  const criticalTemp = {{ critical_temp|default:"1000" }};

  function updateBarChart(data){
    barChart.data.labels = data.map(d=>d.status);
    barChart.data.datasets[0].data = data.map(d=>d.count);
    barChart.update();
  }

  function updateTable(slots){
    const tbody = document.querySelector('#statusTable tbody');
    tbody.innerHTML='';
    const all=[];
    for (const [status, arr] of Object.entries(slots||{})) (arr||[]).forEach(s=>all.push({...s, status}));
    all.sort((a,b)=>(a.endpointid||0)-(b.endpointid||0));
    all.forEach(s=>{
      const temp = parseFloat(s.temp_cur1);
      const hot = !isNaN(temp) && temp >= criticalTemp;
      tbody.insertAdjacentHTML('beforeend', `
        <tr style="${s.status==='BAN'?'background-color:#fc7c7c;':''}">
          <td>‚óè ${s.endpointid ?? '-'}</td>
          <td>${s.status ?? '-'}</td>
          <td>${s.charge ?? '-'}</td>
          <td>${s.sw_name ?? '-'}</td>
          <td style="${hot?'color:red;font-weight:bold;':''}">${s.temp_cur1 ?? '-'}</td>
        </tr>
      `);
    });
  }

  function openCabinet(){
    if (!confirm("–í–∞—à–∏ –¥–µ–π—Å—Ç–≤–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏–µ —à–∫–∞—Ñ–∞?")) return;

    fetch("{% url 'open_cabinet' cabinet.shkaf_id %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "X-Requested-With": "XMLHttpRequest"
      },
    })
    .then(r => r.json())
    .then(data => alert(data.message))
    .catch(e => console.error("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —à–∫–∞—Ñ–∞:", e));
  }

  function updateData(){
    showLoader();
    fetch(`/cabinet/{{ cabinet.shkaf_id }}/update/`, { headers:{ 'X-Requested-With':'XMLHttpRequest' } })
      .then(r=>r.json())
      .then(data=>{
        updateBarChart(data.status_counts||[]);
        updateTable(data.status_slots||{});
      })
      .catch(e=>console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', e))
      .finally(hideLoader);
  }

  function openXModal(sel){
    const el = document.querySelector(sel);
    if (!el) return;
    el.classList.add('active');
    el.addEventListener('click', (evt)=>{
      if (evt.target === el) closeXModal(sel);
    }, { once:true });
  }
  function closeXModal(sel){
    const el = document.querySelector(sel);
    if (!el) return;
    el.classList.remove('active');
  }

  function openInfo(){ openXModal('#info-modal'); }
  function openMap(){
    openXModal('#map-modal');
    if (!(Number.isFinite(LAT) && Number.isFinite(LNG))){
      const mapEl = document.getElementById('map');
      if (mapEl) mapEl.innerHTML = '<div class="text-danger">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –∑–∞–¥–∞–Ω—ã</div>';
      return;
    }
    setTimeout(()=>{
      if (!leafletMap){
        leafletMap = L.map('map').setView([LAT, LNG], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution:'&copy; OpenStreetMap contributors'
        }).addTo(leafletMap);
        L.marker([LAT, LNG]).addTo(leafletMap)
          .bindPopup('–®–∫–∞—Ñ ‚Ññ{{ cabinet.shkaf_id }}')
          .openPopup();
      } else {
        leafletMap.invalidateSize();
        leafletMap.setView([LAT, LNG], 13);
      }
    }, 150);
  }

  function goToGoogleMaps(){
    if (!(Number.isFinite(LAT) && Number.isFinite(LNG))) return;
    window.open(`https://www.google.com/maps?q=${LAT},${LNG}`, '_blank');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const menuBtn = document.getElementById('menu-btn');
    const mapBtn  = document.getElementById('map-btn');
    if (menuBtn) menuBtn.addEventListener('click', openInfo);
    if (mapBtn)  mapBtn.addEventListener('click', openMap);

    document.querySelectorAll('.x-close').forEach(btn=>{
      const target = btn.getAttribute('data-close');
      btn.addEventListener('click', ()=> closeXModal(target));
    });

    const gmapsBtn = document.getElementById('gmaps-btn');
    if (gmapsBtn) gmapsBtn.addEventListener('click', goToGoogleMaps);

    try {
      const counts = JSON.parse('{{ status_counts|default:"[]"|escapejs }}');
      const slots  = JSON.parse('{{ status_slots|default:"{}"|escapejs }}');
      updateBarChart(counts);
      updateTable(slots);
    } catch(e){ console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', e); }

    updateData();
    setInterval(updateData, 15000);
  });
</script>
</body>
</html>
