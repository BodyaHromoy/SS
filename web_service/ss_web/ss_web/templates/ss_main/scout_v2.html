<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –®–∫–∞—Ñ–∞ ‚Ññ{{ cabinet.shkaf_id }}</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:0; }

    .header {
      background:#0056B3; color:#fff; padding:0.5em 1em;
      display:flex; justify-content:space-between; align-items:center;
      position:sticky; top:0; z-index:1000;
    }
    .header .info p { margin:0; font-size:0.9em; }
    .map-icon, .menu-btn { background:none; border:none; color:#fff; font-size:20px; cursor:pointer; }
    .main-content { max-width:900px; margin:0 auto; padding:1em; }
    .card { background:#fff; border-radius:8px; padding:1.5em; box-shadow:0 2px 4px rgba(0,0,0,0.1); margin-bottom:1.5em; }
    table { width:100%; border-collapse:collapse; }
    table th, table td { border:1px solid #ddd; padding:0.75em; text-align:left; }
    table th { background:#f2f2f2; font-size:0.9em; }
    .scrollable-table {
      max-height: calc(100vh - 350px); /* –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤—ã—Å–æ—Ç–∞, –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç —Ñ—É—Ç–µ—Ä */
      overflow-y: auto;
      overflow-x: hidden;
      border: 1px solid #ddd;
    }
    .scrollable-table table thead th {
      position: sticky;
      top: 0;
      background: #f2f2f2;
      z-index: 2;
    }
    .footer {
      position:fixed; bottom:0; width:100%; background:#fff; box-shadow:0 -2px 4px rgba(0,0,0,0.1);
      padding:0.5em 1em; display:flex; justify-content:center; gap:1em; z-index:1000;
    }
    .loader {
      display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
      border:12px solid #f3f3f3; border-top:12px solid #3498db; border-radius:50%;
      width:90px; height:90px; animation:spin 1s linear infinite; z-index:2000;
    }
    @keyframes spin { 0% {transform:translate(-50%,-50%) rotate(0)} 100% {transform:translate(-50%,-50%) rotate(360deg)} }
    .control-panel { padding:0.75em 1em; }
    .control-panel .btn { height:38px; }
    .x-modal {
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      z-index:2000;
      justify-content:center;
      align-items:center;
    }
    .x-modal.active { display:flex; }

    .x-modal-content {
      background:#fff;
      padding:1.5em;
      border-radius:8px;
      max-width:600px;
      width:90%;
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
      position:relative;
    }
    .x-close {
      position:absolute;
      top:10px;
      right:10px;
      background:#0056B3;
      color:#fff;
      border:none;
      padding:0.4em 0.9em;
      border-radius:4px;
      cursor:pointer;
    }

    @media (max-width: 600px) {
      .btn-text { display: none; }
    }
    @media (min-width: 601px) {
      .btn-icon { margin-right: 5px; }
    }

    #map { height:400px; border-radius:6px; }
  </style>
</head>
<body>

<div class="loader" id="loader"></div>

<div class="header">
  <div class="info">
    <p><strong>{{ cabinet.readable_name|default:"-" }}</strong></p>
    <p>ID: {{ cabinet.qr|default:"-" }} | Door: {{ door_state|default:"Unknown" }} | RPi: {{ cabinet.shkaf_id  }}</p>
  </div>
  <button id="map-btn" class="map-icon" title="–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ">üó∫Ô∏è</button>
</div>

<div class="x-modal" id="info-modal">
  <div class="x-modal-content">
    <button class="x-close" data-close="#info-modal">–ó–∞–∫—Ä—ã—Ç—å</button>
    <p><strong>–ó–æ–Ω–∞:</strong> {{ cabinet.zone.zone_name|default:"-" }}</p>
    <p><strong>–õ–æ–∫–∞—Ü–∏—è:</strong> {{ cabinet.street|default:"-" }}</p>
    <p><strong>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:</strong> {{ cabinet.extra_inf|default:"-" }}</p>
    <p><strong>ID –ó–∞–º–∫–∞:</strong> <span id="lock-id">{{ cabinet.qr|default:"-" }}</span>
      <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard('lock-id')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
    </p>
  </div>
</div>

<div class="x-modal" id="map-modal">
  <div class="x-modal-content">
    <button class="x-close" data-close="#map-modal">–ó–∞–∫—Ä—ã—Ç—å</button>
    <h5>–õ–æ–∫–∞—Ü–∏—è –®–∫–∞—Ñ–∞ ‚Ññ{{ cabinet.shkaf_id }}</h5>
    <button class="btn btn-primary mb-2" id="gmaps-btn">–û—Ç–∫—Ä—ã—Ç—å –≤ Google Maps</button>
    <div id="map"></div>
  </div>
</div>

<div class="main-content">
  <div id="chartView" class="card">
    <canvas id="statusBarChart"></canvas>
  </div>

  <div class="card control-panel">
    <form method="get" action="{% url 'export_battery_history' cabinet.shkaf_id %}"
          class="d-flex justify-content-center align-items-center w-100"
          style="gap:8px; flex-wrap:nowrap; overflow-x:auto;">
      <input type="date" id="start_date" name="start_date" class="form-control"
             style="width:120px; min-width:110px; flex-shrink:0;">
      <input type="date" id="end_date" name="end_date" class="form-control"
             style="width:120px; min-width:110px; flex-shrink:0;">

      <button type="submit" class="btn btn-success action-btn" style="white-space:nowrap; flex-shrink:0;">
        <span class="btn-icon">‚Üì</span>
        <span class="btn-text">–°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç</span>
      </button>

      <button type="button" class="btn btn-warning action-btn" style="white-space:nowrap; flex-shrink:0;"
              onclick="openCabinet()">
        <span class="btn-icon">üö™</span>
        <span class="btn-text">–û—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å</span>
      </button>

    </form>
  </div>

  <div id="tableView" class="card">
    <div class="scrollable-table">
      <table id="statusTable">
        <thead>
          <tr>
            <th>–°–ª–æ—Ç</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ó–∞—Ä—è–¥</th>
            <th>–ú–æ–¥–µ–ª—å</th>
            <th>t¬∞</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="footer">
  <button class="btn btn-secondary" onclick="goBack()">–ù–∞–∑–∞–¥</button>
  <button class="btn btn-primary" onclick="updateData()">–û–±–Ω–æ–≤–∏—Ç—å</button>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const LAT = {{ latitude|default:"null" }};
  const LNG = {{ longitude|default:"null" }};
  let leafletMap = null;

  function goBack(){ window.history.back(); }
  function showLoader(){ document.getElementById('loader').style.display='block'; }
  function hideLoader(){ document.getElementById('loader').style.display='none'; }

  function copyToClipboard(id){
    const el = document.getElementById(id);
    if (!el) return;
    navigator.clipboard.writeText(el.textContent || el.innerText || '');
  }

  const barChart = new Chart(document.getElementById('statusBarChart').getContext('2d'), {
    type:'bar',
    data:{
      labels:['BAN','Inactive','ready','empty','charging','not_charging'],
      datasets:[{
        data:[],
        backgroundColor: ctx=>{
          const colors={ BAN:'#610606', Inactive:'black', ready:'green', empty:'gray', charging:'blue', not_charging:'orange' };
          return colors[ctx.chart.data.labels[ctx.dataIndex]] || 'blue';
        }
      }]
    },
    options:{ responsive:true, plugins:{ legend:{ display:false } } }
  });

  const criticalTemp = {{ critical_temp|default:"1000" }};

  function updateBarChart(data){
    barChart.data.labels = data.map(d=>d.status);
    barChart.data.datasets[0].data = data.map(d=>d.count);
    barChart.update();
  }

  function updateTable(slots){
    const tbody = document.querySelector('#statusTable tbody');
    tbody.innerHTML='';
    const all=[];
    for (const [status, arr] of Object.entries(slots||{})) (arr||[]).forEach(s=>all.push({...s, status}));
    all.sort((a,b)=>(a.endpointid||0)-(b.endpointid||0));
    all.forEach(s=>{
      const temp = parseFloat(s.temp_cur1);
      const hot = !isNaN(temp) && temp >= criticalTemp;
      tbody.insertAdjacentHTML('beforeend', `
        <tr style="${s.status==='BAN'?'background-color:#fc7c7c;':''}">
          <td>‚óè ${s.endpointid ?? '-'}</td>
          <td>${s.status ?? '-'}</td>
          <td>${s.charge ?? '-'}</td>
          <td>${s.sw_name ?? '-'}</td>
          <td style="${hot?'color:red;font-weight:bold;':''}">${s.temp_cur1 ?? '-'}</td>
        </tr>
      `);
    });
  }

  function openCabinet(){
    fetch("{% url 'open_cabinet' cabinet.shkaf_id %}", {
      method:"POST",
      headers:{ "X-CSRFToken":"{{ csrf_token }}", "X-Requested-With":"XMLHttpRequest" },
    })
    .then(r=>r.json())
    .then(data=>alert(data.message))
    .catch(e=>console.error("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —à–∫–∞—Ñ–∞:", e));
  }

  function updateData(){
    showLoader();
    fetch(`/cabinet/{{ cabinet.shkaf_id }}/update/`, { headers:{ 'X-Requested-With':'XMLHttpRequest' } })
      .then(r=>r.json())
      .then(data=>{
        updateBarChart(data.status_counts||[]);
        updateTable(data.status_slots||{});
      })
      .catch(e=>console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', e))
      .finally(hideLoader);
  }

  /* ====== –ú–û–î–ê–õ–ö–ò ====== */
  function openXModal(sel){
    const el = document.querySelector(sel);
    if (!el) return;
    el.classList.add('active');
    el.addEventListener('click', (evt)=>{
      if (evt.target === el) closeXModal(sel);
    }, { once:true });
  }
  function closeXModal(sel){
    const el = document.querySelector(sel);
    if (!el) return;
    el.classList.remove('active');
  }

  function openInfo(){ openXModal('#info-modal'); }
  function openMap(){
    openXModal('#map-modal');
    if (!(Number.isFinite(LAT) && Number.isFinite(LNG))){
      const mapEl = document.getElementById('map');
      if (mapEl) mapEl.innerHTML = '<div class="text-danger">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –∑–∞–¥–∞–Ω—ã</div>';
      return;
    }
    setTimeout(()=>{
      if (!leafletMap){
        leafletMap = L.map('map').setView([LAT, LNG], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution:'&copy; OpenStreetMap contributors'
        }).addTo(leafletMap);
        L.marker([LAT, LNG]).addTo(leafletMap)
          .bindPopup('–®–∫–∞—Ñ ‚Ññ{{ cabinet.shkaf_id }}')
          .openPopup();
      } else {
        leafletMap.invalidateSize();
        leafletMap.setView([LAT, LNG], 13);
      }
    }, 150);
  }

  function goToGoogleMaps(){
    if (!(Number.isFinite(LAT) && Number.isFinite(LNG))) return;
    window.open(`https://www.google.com/maps?q=${LAT},${LNG}`, '_blank');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const menuBtn = document.getElementById('menu-btn');
    const mapBtn  = document.getElementById('map-btn');
    if (menuBtn) menuBtn.addEventListener('click', openInfo);
    if (mapBtn)  mapBtn.addEventListener('click', openMap);

    document.querySelectorAll('.x-close').forEach(btn=>{
      const target = btn.getAttribute('data-close');
      btn.addEventListener('click', ()=> closeXModal(target));
    });

    const gmapsBtn = document.getElementById('gmaps-btn');
    if (gmapsBtn) gmapsBtn.addEventListener('click', goToGoogleMaps);

    try {
      const counts = JSON.parse('{{ status_counts|default:"[]"|escapejs }}');
      const slots  = JSON.parse('{{ status_slots|default:"{}"|escapejs }}');
      updateBarChart(counts);
      updateTable(slots);
    } catch(e){ console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', e); }

    updateData();
    setInterval(updateData, 15000);
  });
</script>
</body>
</html>
