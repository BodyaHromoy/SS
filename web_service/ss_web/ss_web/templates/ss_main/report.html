<!DOCTYPE html>
{% load static %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS</title>
    <link rel="shortcut icon" type="image/png" href="{% static 'favicon.ico' %}"/>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <style>
    body {
        background-color: #6495ED;
        color: black;
        padding: 10px;
        font-family: Arial, sans-serif;
    }

    h1 {
        color: white;
        text-align: center;
        font-size: 2em;
        margin-bottom: 20px;
    }

    .container-fluid {
        border-radius: 10px;
        background-color: #fff;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        max-width: 800px;
        margin: 0 auto;
    }

    label, button, a {
        margin-top: 10px;
    }

    .autocomplete-items {
        position: absolute;
        border: 1px solid #d4d4d4;
        border-bottom: none;
        border-top: none;
        z-index: 99;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 200px;
        overflow-y: auto;
        background-color: white;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    }

    .autocomplete-items div {
        padding: 10px;
        cursor: pointer;
        background-color: #fff;
        border-bottom: 1px solid #d4d4d4;
    }

    .autocomplete-items div:hover {
        background-color: #f1f1f1;
    }

    .selected-values {
        margin-top: 10px;
    }

    .selected-item {
        display: inline-block;
        padding: 5px;
        margin: 5px;
        background-color: #e9e9e9;
        border: 1px solid #d4d4d4;
        border-radius: 5px;
    }

    .selected-item button {
        background: none;
        border: none;
        color: red;
        cursor: pointer;
    }

    .form-group {
        position: relative;
        margin-bottom: 20px;
    }

    .btn-primary {
        background-color: #6495ED;
        border-color: #6495ED;
    }

    .btn-secondary {
        color: #fff;
        background-color: #6c757d;
        border-color: #6c757d;
    }
</style>
    </style>
</head>

<body>
<h1>Charge monitoring reports:</h1>
<div class="container-fluid">
    <form method="post">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <div class="form-group">
        <label for="city">City:</label>
        <input type="text" id="city" name="city">
        <div id="city_list" class="autocomplete-items"></div>
    </div>
    <div class="form-group">
        <label for="zone">Zone:</label>
        <input type="text" id="zone" name="zone">
        <div id="zone_list" class="autocomplete-items"></div>
    </div>
    <div class="form-group">
        <label for="station_id">Station ID:</label>
        <input type="text" id="station_id" name="station_id">
        <div id="station_id_list" class="autocomplete-items"></div>
    </div>
    <div class="form-group">
        {{ form.time_from.label_tag }}
        {{ form.time_from }}
    </div>
    <div class="form-group">
        {{ form.time_to.label_tag }}
        {{ form.time_to }}
    </div>
    <div class="form-group form-check">
        {{ form.select_all }}
        {{ form.select_all.label_tag }}
    </div>
    <button type="submit" class="btn btn-primary">Download report</button>
    <a href="{% url 'reset_selection' %}" class="btn btn-secondary">Reset selection</a>
</form>
</div>

<script>
function setupAutocomplete(inputElement, url) {
    let dataList = document.createElement('div');
    dataList.className = 'autocomplete-items';
    dataList.style.position = 'absolute';
    dataList.style.top = inputElement.offsetHeight + 'px';
    dataList.style.width = inputElement.offsetWidth + 'px';
    inputElement.parentNode.appendChild(dataList);

    let timeout = null;
    inputElement.addEventListener('input', function(e) {
        clearTimeout(timeout);
        timeout = setTimeout(fetchOptions, 300);
    });

    inputElement.addEventListener('focus', fetchOptions);

    function fetchOptions() {
        let currentValue = inputElement.value;
        dataList.innerHTML = '';

        let queryUrl = url;
        if (currentValue) {
            queryUrl += '?query=' + currentValue;
        }
        fetch(queryUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.length === 0) {
                    dataList.style.display = 'none';
                } else {
                    data.forEach(function(item) {
                        let option = document.createElement('div');
                        let displayItem = item.split('-')[0]; // Отображаем только часть до "-"
                        option.innerHTML = displayItem.replace(currentValue, `<strong>${currentValue}</strong>`);
                        option.className = 'autocomplete-option';
                        option.addEventListener('click', function() {
                            let selectedItem = document.createElement('div');
                            selectedItem.className = 'selected-item';
                            selectedItem.innerHTML = displayItem + '<button type="button">x</button>';
                            selectedItem.querySelector('button').addEventListener('click', function() {
                                selectedItem.remove();
                            });
                            inputElement.parentNode.appendChild(selectedItem);

                            inputElement.value = '';
                            dataList.innerHTML = '';
                            dataList.style.display = 'none';
                        });
                        dataList.appendChild(option);
                    });
                    dataList.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
    }

    let activeOption = -1;
    inputElement.addEventListener('keydown', function(e) {
        if (e.key === 'ArrowDown') {
            activeOption = Math.min(activeOption + 1, dataList.children.length - 1);
        } else if (e.key === 'ArrowUp') {
            activeOption = Math.max(activeOption - 1, -1);
        } else if (e.key === 'Enter' && activeOption > -1) {
            dataList.children[activeOption].click();
            e.preventDefault();
        }

        Array.from(dataList.children).forEach((option, i) => {
            if (i === activeOption) {
                option.classList.add('active');
            } else {
                option.classList.remove('active');
            }
        });
    });

    document.addEventListener('click', function(e) {
        if (e.target !== inputElement) {
            dataList.innerHTML = '';
            dataList.style.display = 'none';
        }
    });
}

// Подключаем автозаполнение к полям
setupAutocomplete(document.getElementById('station_id'), '/api/station_ids');
setupAutocomplete(document.getElementById('city'), '/api/cities');
setupAutocomplete(document.getElementById('zone'), '/api/zones');
</script>

</body>
</html>
